unit uPedidoController;

interface

uses FireDAC.Comp.Client, uConexaoFiredac;

Type
  TPedidoController = class
  public
    class function CalculaTotal(cQuant, cVlr: Currency): Currency;
    class function GravarPedido(codcli: Integer; vlrpedido: Currency): Integer;

  end;

implementation

{ TPedidoController }

uses uDm, System.SysUtils;

class function TPedidoController.CalculaTotal(cQuant, cVlr: Currency): Currency;
begin
  Result := cQuant * cVlr;
end;

class function TPedidoController.GravarPedido(codcli: Integer;
  vlrpedido: Currency): Integer;
var
  Query: TFDQuery;
  Transaction: TFDTransaction;
begin
  Result := 0;

  Transaction := TFDTransaction.Create(Nil);
  Transaction.Connection := Dm.FConexao;

  if Transaction.Active then
    Transaction.Commit;
  Transaction.StartTransaction;

  try
    try

      Query := TConexaoFiredac.getInstancia.prepareStatement
        ('insert into PEDIDO_VENDA ( data_emissao, ' +
        ' cod_cli, valor_pedido) values ( :DATA_EMISSAO, ' +
        ':COD_CLI, :VALOR_PEDIDO)  ');
      Query.Transaction := Transaction;

      Query.parambyname('DATA_EMISSAO').AsDate := Date();
      Query.parambyname('COD_CLI').AsInteger := codcli;
      Query.parambyname('VALOR_PEDIDO').AsCurrency := vlrpedido;

      Query.ExecSQL;
      Transaction.Commit;

      Query := TConexaoFiredac.getInstancia.prepareStatement
        ('SELECT LAST_INSERT_ID() as codigo ');
      Query.Open;

      Result := Query.FieldByName('codigo').AsInteger;

    finally
      TConexaoFiredac.getInstancia.closeConnection(Query);
    end;
  except
    Transaction.Rollback;
  end;
end;

end.
